
# coding: utf-8
"""
"""

import os
import logging

import mne

import numpy as np
import scipy


def prepare_data_for_permutation(experiment, design, groups, conditions,
                                 item_type, item_name, 
                                 location_limits, time_limits, frequency_limits,
                                 data_format=('freqs', 'times', 'locations')):
    """
    """
    final_data = {}
    if design == 'between-subjects':
        for condition in conditions:
            data_by_group = []
            for group in groups.values():
                group_data = []
                for subject_name in group:
                    subject = experiment.subjects[subject_name]
                    subject_item = getattr(subject, item_type).get(item_name)
                    if not subject_item:
                        message = "Skipping " + subject_name + " (no " + str(item_type) + ")"
                        logging.getLogger('ui_logger').warning(message) 
                    data = subject_item.content[condition].T
                    group_data.append(data)
                data_by_group.append(np.array(group_data))
            final_data[condition] = list(data_by_group.values())
        return final_data
    elif design == 'within-subjects':
        final_data = {}
        for group_key, group in groups.items():

            # n_subjects = len(group)
            # if location_limits is not None:
            #     data_in_conditions = np.zeros((n_conditions, n_subjects, n_freqs, 1))
            # elif frequency_limits is not None:
            #     data_in_conditions = np.zeros((n_conditions, n_subjects, 1, n_channels))
            # else:
            #     data_in_conditions = np.zeros((n_conditions, n_subjects, n_freqs, n_channels))

            group_data = []
            for subject_idx, subject_name in enumerate(group):
                subject = experiment.subjects[subject_name]
                subject_item = getattr(subject, item_type).get(item_name)
                if not subject_item:
                    message = "Skipping " + subject_name + " (no " + str(item_type) + ")"
                    logging.getLogger('ui_logger').warning(message) 

                # The format needed is:
                # (n_conds, n_subjects, ..., n_channels)
                cond_data = []
                for condition_idx, condition in enumerate(conditions):
                    # data = subject_item.content[condition].T
                    # 
                    data = subject_item.content[condition]
                    if frequency_limits is not None:
                        # average over the selected frequency range
                        freqs = subject_item.freqs
                        fmin_idx = np.where(freqs >= frequency_limits[0])[0][0]
                        fmax_idx = np.where(freqs <= frequency_limits[1])[0][-1]
                        swapped = np.swapaxes(data, data_format.index('freqs'), 0)
                        averaged = np.mean(swapped[fmin_idx:fmax_idx], axis=0)[np.newaxis, :]
                        data = np.swapaxes(averaged, data_format.index('freqs'), 0)
                    if location_limits is not None:
                        # take the seleted location
                        ch_names = subject_item.ch_names
                        ch_idx = ch_names.index(location_limits)
                        swapped = np.swapaxes(data, data_format.index('locations'), 0)
                        selected = data[ch_idx][np.newaxis, :]
                        data = np.swapaxes(selected, data_format.index('locations'), 0)
                    if time_limits is not None:
                        # average over the selected temporal range
                        times = subject_item.times
                        tmin_idx = np.where(times >= time_limits[0])[0][0]
                        tmax_idx = np.where(times <= time_limits[1])[0][-1]
                        swapped = np.swapaxes(data, data_format.index('times'), 0)
                        averaged = np.mean(swapped[tmin_idx:tmax_idx], axis=0)[np.newaxis, :]
                        data = np.swapaxes(averaged, data_format.index('times'), 0)
                    cond_data.append(data)
                group_data.append(cond_data)

            from meggie.utilities.debug import debug_trace;
            debug_trace()
    else:
        raise Exception("Only within and between subjects designs are supported")

    return X

